parameters:
- name: DoPackageSecurityCheck
  type: boolean
  default: true
- name: ProjectKey
  type: string
- name: Stack
  displayName: Stack technology
  type: string
  values:
    - MSBuild
    - Other
    - CLI
- name: PreAnalysisSteps
  type: stepList
  default: []
- name: AfterPrepareSteps
  type: stepList
  default: []
- name: PostAnalysisSteps
  type: stepList
  default: []
- name: CodeRoot
  type: string
  default: ''

steps:
  - ${{ each step in parameters.PreAnalysisSteps }}:
    - ${{ each pair in step }}:
        ${{ pair.key }}: ${{ pair.value }} 

  - task: whitesource.ws-bolt.bolt.wss.WhiteSource Bolt@20
    displayName: 'WhiteSource Bolt'
    condition: eq('${{ parameters.DoPackageSecurityCheck }}', 'true')
  
  - ${{ if ne(parameters.Stack, 'CLI') }}:
    - task: SonarCloudPrepare@1
      condition: ne('${{ parameters.Stack }}', 'CLI')
      displayName: SonarCloudPrepare - MSBuild analysis
      inputs:
        SonarCloud: 'SonarCloud'
        organization: 'bulgaridigital'
        scannerMode: '${{ Parameters.Stack }}'
        projectKey: '${{ Parameters.ProjectKey }}'
        projectName: '${{ Parameters.ProjectKey }}' 
  - ${{ else }}:
    - bash: exit 1
      displayName: Check if project sources was specified
      condition: eq('${{ parameters.CodeRoot }}', '')
    - task: SonarCloudPrepare@1
      displayName: 'SonarCloudPrepare - CLI analysis'
      inputs:
        SonarCloud: 'SonarCloud'
        organization: bulgaridigital
        scannerMode: CLI
        configMode: manual
        cliProjectKey: '${{ Parameters.ProjectKey }}'
        cliProjectName: '${{ Parameters.ProjectKey }}'
        cliSources: '${{ Parameters.CodeRoot }}'

  - ${{ each step in parameters.AfterPrepareSteps }}:
    - ${{ each pair in step }}:
        ${{ pair.key }}: ${{ pair.value }} 

  - task: SonarCloudAnalyze@1

  - task: SonarCloudPublish@1
    inputs:
      pollingTimeoutSec: '300'

  - ${{ each step in parameters.PostAnalysisSteps }}:
    - ${{ each pair in step }}:
        ${{ pair.key }}: ${{ pair.value }} 